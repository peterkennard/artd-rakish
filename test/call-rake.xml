<?xml version="1.0" encoding="UTF-8"?>
<project name="call-rake" default="">

	<dirname property="my.directory" file="${ant.file.call-rake}"/>
	<dirname property="jsdk.home" file="${java.home}"/>

	<condition property="rake.exec.path"
			   value="${my.directory}\..\..\..\third-party\tools\exec-rake.bat"
			   else="/usr/bin/rake">
		<os family="windows"/>
	</condition>

	<target name="showprops">
		<echoproperties/>
	</target>


    <macrodef name="call-rake">
		<attribute name="file" default="./rakefile.rb"/>
        <attribute name="target" default="_not_set_" />
		<attribute name="log" default="rake.log"/>
		<attribute name="trace" default=""/>
		<attribute name="rake.path" default="${rake.exec.path}"/>
		<attribute name="java.home" default="${jsdk.home}"/>
		<attribute name="idea.project" default="${user.dir}/.idea"/>
        <sequential>
			<property name="_rake_target_" value="@{target}" />
			<script language="javascript">
				if(project.getProperty("_rake_target_") == "_not_set_") {
					project.setProperty("_rake_target_", self.getOwningTarget());
				}
			</script>
			<record name="@{log}" action="start"/>
		    <exec executable="cmd">
                <arg value="/c"/>
                <arg value="@{rake.path}"/>
                <arg value="-f"/>
                <arg value="@{file}"/>
                <arg value="@{trace}"/>
                <arg value="${_rake_target_}"/>
				<arg value="&quot;'JAVA_HOME=@{java.home}'&quot;"/>
				<arg value="&quot;'IDEA_PROJECT=@{idea.project}'&quot;"/>
            </exec>
            <record name="@{log}" action="stop"/>
        </sequential>
    </macrodef>

</project>